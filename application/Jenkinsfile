pipeline {
  agent {
    kubernetes {
      label 'kaniko'
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command:
        - cat
      tty: true
"""
    }
  }
  environment {
    DOCKER_REGISTRY = 'docker.io'
    DOCKER_REPO     = 'b4w4rzr1ng/jenkins'
    IMAGE_TAG       = 'latest'
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build & Push') {
      steps {
        container('kaniko') {
          /* This block supplies the Docker credentials to Kaniko */
          withCredentials([usernamePassword(
              credentialsId: 'docker hub',     // The ID you created in Jenkins
              usernameVariable: 'DOCKER_USER',
              passwordVariable: 'DOCKER_PASS'
          )]) {
            sh """
              echo "Writing Docker Hub credentials to /kaniko/.docker/config.json..."
              mkdir -p /kaniko/.docker
              cat <<EOF > /kaniko/.docker/config.json
{
  "auths": {
    "https://index.docker.io/v1/": {
      "auth": "$(echo -n ${DOCKER_USER}:${DOCKER_PASS} | base64)"
    }
  }
}
EOF

              echo "Building Docker image using Kaniko..."
              /kaniko/executor \\
                --dockerfile \${WORKSPACE}/application/Dockerfile \\
                --context    \${WORKSPACE}/application \\
                --destination \${DOCKER_REGISTRY}/\${DOCKER_REPO}:\${IMAGE_TAG}
            """
          }
        }
      }
    }
  }
}
